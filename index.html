<!DOCTYPE html>
<html>
	<head>
		<title>24-tone Perfect Pitch Tester</title>
		<meta charset="utf-8">
		<script>
			if (localStorage[  "correct"] == undefined) localStorage[  "correct"] = 0;
			if (localStorage["incorrect"] == undefined) localStorage["incorrect"] = 0;

			let noteNames; // initialized in onLoad
			let unanswered = true;
			let answer;
			let octave;
			let pitch;

			// https://github.com/escottalexander/simpleTones.js
			const context = new (window.AudioContext || window.webkitAudioContext)();
			function hearTone() {
				var oscillatorNode = context.createOscillator();
				var gainNode = context.createGain();

				oscillatorNode.type = "sine";
				oscillatorNode.frequency.setValueAtTime(pitch, context.currentTime);

				gainNode.gain.setValueAtTime(0.3, context.currentTime);
				gainNode.gain.setValueCurveAtTime([1.0, 0.61, 0.37, 0.22, 0.14, 0.08, 0.05, 0.0], context.currentTime, 2.0);

				oscillatorNode.connect(gainNode);
				gainNode.connect(context.destination);

				oscillatorNode.start();
				oscillatorNode.stop(context.currentTime + 1); // duration = 1s
			}

			function renderStats() {
				const correct = ~~localStorage["correct"];
				const total = ~~localStorage["incorrect"] + correct;
				document.getElementById("success").textContent = "Correct: " + correct;
				document.getElementById("failure").textContent = "Total: " + total;
				document.getElementById("percent").textContent = "Rate: " + ~~(100 * (correct / (total))) + "%";
			}

			function resetStats() {
				localStorage["correct"] = localStorage["incorrect"] = 0;
				renderStats();
			}

			function reset() {
				unanswered = true;
				answer = ~~(Math.random() * 24);
				const min = ~~document.getElementById("minOctave").value;
				octave = ~~(Math.random() * (document.getElementById("maxOctave").value - min + 1)) + min;
				pitch = 261.63 * (2 ** (answer/24 + octave - 4));
			}

			function select(num) {
				if (num == answer) {
					if (unanswered) localStorage["correct"]++;
					alert("Correct!");
				} else {
					if (unanswered) localStorage["incorrect"]++;
					alert("Wrong! The answer was " + noteNames[answer] + octave + " (" + ~~(100 * pitch)/100 + "Hz)");
				}

				unanswered = false;
				renderStats();
			}


			window.onload = () => {
				["minOctave","maxOctave"].forEach(x => {
					const el = document.getElementById(x);
					const v = localStorage[x];
					if (v != undefined) el.value = v;
					const callback = () => {
						document.getElementById(x + "Display").textContent = "M" + x.slice(1,3) + "imum octave: " + el.value
						localStorage[x] = el.value;
					};
					callback();
					el.addEventListener("input", callback);
				});
				noteNames = Array.from(document.getElementById("answers").childNodes).filter(x => x.nodeName == "BUTTON").map(x => x.innerText);
				reset();
				renderStats();
			}
		</script>
		<style>
			body {
				background-color: #111;
			}
			.content {
				display: grid;
				grid-template-columns: 20% 80%;
			}
			.footer {
				position: fixed;
				bottom: 0;
			}
			.choice {
				width: 5em;
				height: 2em;
			}
			.center, .centerContents > * {
				display: flex;
				justify-content: center;
			}
			button {
				border-color: #666;
				background-color: #222;
			}
			p, h2, h3, h4, input, button {
				color: #FFF;
				white-space: pre;
			}
		</style>
	</head>
	<body>
		<div class="content">
			<div class="settings">
				<h3>SETTINGS:</h3>
				<p id="minOctaveDisplay"></p>
				<input type="range" id="minOctave" min="1" max="8" value="2"/>
				<p id="maxOctaveDisplay"></p>
				<input type="range" id="maxOctave" min="1" max="8" value="6"/>
			</div>
			<div class="header">
				<h2>24-tone Perfect Pitch Tester</h2>
				<p>              "Now with real CSS!"</p>
				<p>This is a test to allow you to train/practice perfect pitch for quarter-tone increments.</p>
			</div>
			<div class="statistics">
				<h3>STATS:</h3>
				<p id="success"></p>
				<p id="failure"></p>
				<p id="percent"></p>
				<button onclick="resetStats()">RESET</button>
			</div>
			<div class="test">
				<h3>TEST:</h3>
				<button onclick="hearTone()">HEAR</button>
				<button onclick="reset()">NEW TEST</button>
				<br>
				<h4>Answer choices:</h4>
				<div id="answers">
					<button class="choice" onclick="select(0)" >C</button>
					<button class="choice" onclick="select(1)" >C𝄲</button>
					<button class="choice" onclick="select(2)" >C♯/D♭</button>
					<button class="choice" onclick="select(3)" >C♯𝄲</button>
					<button class="choice" onclick="select(4)" >D</button>
					<button class="choice" onclick="select(5)" >D𝄲</button>
					<button class="choice" onclick="select(6)" >D♯/E♭</button>
					<button class="choice" onclick="select(7)" >D♯𝄲</button>
					<button class="choice" onclick="select(8)" >E</button>
					<button class="choice" onclick="select(9)" >E𝄲</button>
					<button class="choice" onclick="select(10)">F</button>
					<button class="choice" onclick="select(11)">F𝄲</button>
					<button class="choice" onclick="select(12)">F♯/G♭</button>
					<button class="choice" onclick="select(13)">F♯𝄲</button>
					<button class="choice" onclick="select(14)">G</button>
					<button class="choice" onclick="select(15)">G𝄲</button>
					<button class="choice" onclick="select(16)">G♯/A♭</button>
					<button class="choice" onclick="select(17)">G♯𝄲</button>
					<button class="choice" onclick="select(18)">A</button>
					<button class="choice" onclick="select(19)">A𝄲</button>
					<button class="choice" onclick="select(20)">A♯/B♭</button>
					<button class="choice" onclick="select(21)">A♯𝄲</button>
					<button class="choice" onclick="select(22)">B</button>
					<button class="choice" onclick="select(23)">B𝄲</button>
				</div>
				<p>If you see replacement characters; they are half-sharps.</p>
			<p class="footer">Website copyright Napkin Technologies. Tones generated with code from <a href="https://github.com/escottalexander/simpleTones.js">simpleTones library</a>.</p>
		</div>
	</body>
</html>
